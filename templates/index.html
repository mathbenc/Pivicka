<!doctype html>
<title>{{ title }}</title>
<html>

<head>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.7/js/tether.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.1.0/tablesort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.1.0/sorts/tablesort.number.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
    integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css">
  <script src="https://unpkg.com/sticky-table-headers"></script>
  <script src="https://kit.fontawesome.com/a9c2dc6b0c.js" crossorigin="anonymous"></script>
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-static-top navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      <img src="/static/beer_emoji.png" width="30" height="30" class="d-inline-block align-top" alt="">&nbsp
      Na zdrav(ljen)je!
    </a>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto" style="margin-right: 24px;">
        <li class="nav-item">
          <a href="https://www.rtvslo.si/zdravje/novi-koronavirus" class="text-decoration-none nav-link" target="_blank">
            <i class="far fa-newspaper" ></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://www.reddit.com/r/Coronavirus/" class="text-decoration-none nav-link" target="_blank">
            <i class="fab fa-reddit"></i>
          </a>
        </li>
      </ul>
    </div>

    <form class="form-inline">
      <input class="form-control form-control-sm mr-auto" id="search" placeholder="Poišči državo">
    </form>
  </nav>

  <div class="table-responsive-lg">
    <table id="dataTable" class="table table-striped table-hover"></table>
  </div>
</body>
<script>

  $("#search").keyup( function() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("search");
    filter = input.value.toUpperCase();
    table = document.getElementById("dataTable");
    tr = table.getElementsByTagName("tr");

    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByTagName("td")[0];
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      } 
    }
  });

  var countries = [];
  var population = [];
  var infected = [];
  var dead = [];
  var cured = [];
  var infectedRatio = [];
  var deadRatio = [];
  var updateTime = [];

  var coronaData = JSON.parse({{corona_data|tojson|safe}}).results;
  var countryData = JSON.parse({{country_data|tojson|safe}});

  //Spremenimo Iran (Islamic State) v Iran
  for (var i=0; i<countryData.length; i++) {
    if (countryData[i].name == "Iran (Islamic Republic of)") {
      countryData[i].name = "Iran";
    }
  }

  // Zberemo vse podatke o Kitajski v eno polje
  var counter = 0;
  countries.push("China");
  population.push(1386000000);

  infected.push(0);
  dead.push(0);
  cured.push(0);

  var timestamp = 0;
  for (var i=0; i<coronaData.length; i++) {
    if (coronaData[i].countryEnglishName == "China") {      
      // Podatki o Pivu
      infected[0] = infected[0] + coronaData[i].confirmedCount;
      dead[0] = dead[0] + coronaData[i].deadCount;
      cured[0] = cured[0] + coronaData[i].curedCount;
      if (coronaData[i].updateTime > timestamp) {
        timestamp = coronaData[i].updateTime;
      }
    }
  }

  updateTime.push(formatDateTime(timestamp));
  infectedRatio.push(parseFloat((infected[0] * 100 / population[0]).toFixed(5)));
  deadRatio.push(parseFloat((dead[0] * 100 / infected[0]).toFixed(5)));

  // Formatiramo...
  infected[0] = formatNumber(infected[0]);
  dead[0] = formatNumber(dead[0]);
  cured[0] = formatNumber(cured[0]);
  population[0] = formatNumber(population[0]);

  for (var i = 0; i < coronaData.length; i++) {
    for (var j = 0; j < countryData.length; j++) {
      if (coronaData[i].provinceEnglishName == countryData[j].name) {

        // Podatki o državi
        countries.push(countryData[j].name);
        population.push(formatNumber(countryData[j].population));

        // Podatki o Pivu
        infected.push(formatNumber(coronaData[i].confirmedCount));
        dead.push(formatNumber(coronaData[i].deadCount));
        cured.push(formatNumber(coronaData[i].curedCount));

        // Čas zadnje posodobitve podatkov...moramo pretvoriti format
        updateTime.push(formatDateTime(coronaData[i].updateTime));

        // Moje računanje
        infectedRatio.push(parseFloat((coronaData[i].confirmedCount * 100 / countryData[j].population).toFixed(5)));
        deadRatio.push(parseFloat((coronaData[i].deadCount * 100 / coronaData[i].confirmedCount).toFixed(5)));

        break;
      }
    }
  }

  function formatDateTime(timestamp) {
    var date = new Date(timestamp);
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hours = date.getHours();
    var minutes = "0" + date.getMinutes();
    var formattedTime = day + "." + month + "." + year + " " + hours + ":" + minutes.substr(-2);
    return formattedTime
  }

  function formatNumber(num) {
    return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
  }

  function tableCreate() {
    var headers = ["Država", "Populacija", "Okuženi", "Delež okuženih", "Mrtvi", "Delež mrtvih", "Ozdravljeni", ""];
    var tbl = document.getElementById('dataTable');
    var tbdy = document.createElement('tbody');
    var thdr = tbl.createTHead();
    thdr.setAttribute("class", "thead-dark");
    var row = thdr.insertRow();
    for (var i = 0; i < headers.length; i++) {
      var cell = document.createElement("th");
      cell.setAttribute("style", "border:none !important; cursor: pointer;");
      cell.innerHTML = headers[i];
      if (headers[i] == "Okuženi") {
        cell.setAttribute("data-sort-default", "")
      } else if (i == headers.length - 1) {
        cell.setAttribute("data-sort-method", "none")
        cell.removeAttribute("style");
        cell.setAttribute("style", "border:none !important;");
      }
      if (i != 0) {
        cell.setAttribute("class", "text-right");
      }
      row.appendChild(cell);
    }
    for (var i = 0; i < countries.length; i++) {
      var row = tbdy.insertRow();
      var cell = row.insertCell();
      cell.innerHTML = countries[i];
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = population[i];
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = infected[i];
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = infectedRatio[i] + "%";
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = dead[i];
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = deadRatio[i] + "%";
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = cured[i];
      cell = row.insertCell();
      cell.setAttribute("align", "right");
      cell.innerHTML = '<i class="far fa-question-circle" tabindex="0" data-trigger="focus" data-toggle="popover" data-placement="left" data-content="' + updateTime[i] + '"></i>';
    }
    tbl.appendChild(tbdy);
  }
  tableCreate();

  // Zaženemo plugin za sortiranje
  new Tablesort(document.getElementById("dataTable"), {
    descending: true
  });

  // Zaženemo plugin za stickanje headerjev
  $('table').stickyTableHeaders();

  $(function () {
    $('[data-toggle="popover"]').popover()
  })

  $('.popover-dismiss').popover({
    trigger: 'focus'
  })

</script>

</html>