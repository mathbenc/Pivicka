<!doctype html>
<html lang="sl">

<head>
  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,500,700&display=swap" rel="stylesheet"> 
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <!-- Bootstrap core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/css/mdb.min.css" rel="stylesheet">
  <!-- MDBootstrap Datatables  -->
  <link href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">

  <!-- Primary Meta Tags -->
  <title>Pivička</title>
  <meta name="title" content="Pivička - Koronavirus po svetu v številkah">
  <meta name="description" content="Podakti o okuženosti, umrljivosti, novih okužbah in poteku širjenja bolezni COVID-19 za države, ki so zaznale okužbo s SARS-CoV-2.">
  <meta name="keywords" content="corona,coronavirus,koronavirus,korona,virus,covid-19,pivicka,sars-cov-2,pivička">
  <meta name="author" content="M4thB3nc">
  <meta http-equiv="content-language" content="sl-sl">
  <meta charset="UTF-8">

  <!-- Web App Tags -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <script async src="https://cdn.jsdelivr.net/npm/pwacompat@2.0.10/pwacompat.min.js"
    integrity="sha384-I1iiXcTSM6j2xczpDckV+qhhbqiip6FyD6R5CpuqNaWXvyDUvXN5ZhIiyLQ7uuTh"
    crossorigin="anonymous"></script>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Pivička">
  <meta name="apple-mobile-web-app-title" content="Pivička">
  <meta name="msapplication-navbutton-color" content="#ffeb3b">
  <meta name="apple-mobile-web-app-status-bar-style" content="ffeb3b">
  <meta name="msapplication-starturl" content="/">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no">

  <link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png?v=47BGjb09Ka">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32x32.png?v=47BGjb09Ka">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16x16.png?v=47BGjb09Ka">
  <link rel="mask-icon" href="/static/images/safari-pinned-tab.svg?v=47BGjb09Ka" color="#ffeb3b">
  <link rel="shortcut icon" href="/static/images/favicon.ico?v=47BGjb09Ka">
  <meta name="msapplication-TileColor" content="#ffeb3b">
  <meta name="msapplication-config" content="/static/images/browserconfig.xml?v=47BGjb09Ka">
  <meta name="theme-color" content="#ffeb3b">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pivicka.eu/">
  <meta property="og:title" content="Pivička">
  <meta property="og:description" content="Koronavirus po svetu v številkah.">
  <meta property="og:image" content="https://pivicka.eu/static/images/PivickaThumbnail.png">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://pivicka.eu/">
  <meta property="twitter:title" content="Pivička">
  <meta property="twitter:description" content="Koronavirus po svetu v številkah.">
  <meta property="twitter:image" content="https://pivicka.eu/static/images/PivickaThumbnail.png">

</head>

<body>
    
    <!-- Navbar -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-light">

      <!-- Navbar brand -->
      <a class="navbar-brand">
        <img id="logotip" src="./static/images/icon-test-alt.png" height="25">
        <!-- <i id="logotip" class="fas fa-beer fa-lg"></i> -->
        <span data-toggle="modal" data-target="#infoModal"><b>Pivička</b></span>
      </a>


      <!-- Collapse button -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Collapsible content -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">

          <li class="nav-item mr-2">
            <span class="nav-link"><i class="fas fa-biohazard"></i><span id="globalCases">{{ globalData["cases"] }}</span></span>
          </li>
          <li class="nav-item mr-2">
            <span class="nav-link"><i class="fas fa-book-dead"></i><span id="globalDeaths">{{ globalData["deaths"] }}</span></span>
          </li>
          <li class="nav-item mr-2">
            <span class="nav-link"><i class="fas fa-smile-beam"></i><span id="globalRecovered">{{ globalData["recovered"] }}</span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="modeSwitch()"><i id="globeSwitch" class="fa fa-globe"></i><span id="globeText"> Svet&nbsp&nbsp</span></a>
          </li>

        </ul>

        <form class="form-inline my-0" id="searchContainer"> 
          <div class="md-form form-sm my-0 active-pink active-pink-2">
            <input class="form-control form-control-sm mr-sm-2" type="text" aria-label="Išči državo" id="search"
              placeholder="Išči državo">
          </div>
        </form>

      </div>

    </nav>


    <!-- Tabela -->
    <div class="fakeThead"></div>
    <div class="tableFixHead" id="mainDiv">
      <table id="dataTable" class="table table-hover" style="margin-bottom: 0px !important;"></table>
    </div>
        

    <!-- Modal -->
    <div class="modal fade bottom" id="countryDetailsModal" tabindex="-1" role="dialog"
      aria-labelledby="countryDetailsModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-full-height modal-bottom modal-notify"
        role="document">

        <div class="modal-content">
          <div class="modal-header" id="countryDetailsModalHeader">
            <p class="heading lead modal-title w-100"><b id="countryDetailsModalTitle"></b></p>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div id="countryDetailsModalBody" class="modal-body container text-center">
            <div class="row">
              <!-- <div class="col-3"><b>Zastava</b><br><img height="24px" id="countryFlag"></img></div> -->
              <div class="col-4"><b>Populacija</b>
                <p id="populationModal"></p>
              </div>
              <div class="col-4"><b>Poseljenost</b>
                <p id="countryDensity"></p>
              </div>
              <div class="col-4"><b>Okuženi</b>
                <p id="infectedModal"></p>
              </div>

              <div class="w-100"></div>

              <div class="col-3"><b>Danes okuženi</b>
                <p id="infectedTodayModal"></p>
              </div>
              <div class="col-3"><b>Obolevnost</b>
                <p id="infectedRatioModal"></p>
              </div>
              <div class="col-3"><b>Umrli</b>
                <p id="deadModal"></p>
              </div>
              <div class="col-3"><b>Danes umrli</b>
                <p id="deadTodayModal"></p>
              </div>

              <div class="w-100"></div>

              <div class="col-3"><b>Umrljivost</b>
                <p id="deadRatioModal"></p>
              </div>
              <div class="col-3"><b>Ozdraveli</b>
                <p id="curedModal"></p>
              </div>
              <div class="col-3"><b>Odprti primeri</b>
                <p id="activeModal"></p>
              </div>
              <div class="col-3"><b>Kritični primeri</b>
                <p id="criticalModal"></p>
              </div>
            </div>
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>
    </div>


    <div class="modal fade bottom" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModal" aria-hidden="true">
      <div class="modal-dialog modal-frame modal-bottom" role="document">
        <div class="modal-content">
          <div class="modal-body container text-center">
            <div class="row">
              <div class="col">
                <h1 class="h1-responsive">Pivička - Koronavirus po svetu v številkah</h1>
                <br>
                <br>
              </div>
            </div>
            <div class="row">
              <div class="col">
                Zadnja posodobitev: {{ dataTime }}
                <br>
                Vir: <a href={{ source }}>{{ source }}</a>
                <br>
                <br>
                <div>Made by M4thB3nc</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- SCRIPTS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.1.0/tablesort.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.1.0/sorts/tablesort.number.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.js"></script>

  <!-- JQuery -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js">
  </script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/js/mdb.min.js"></script>
  <!-- MDBootstrap Datatables  -->
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>

  <script src="{{ url_for('static', filename='app.js') }}"></script>

  <script>
    var currentTheme = "light";
    function themeSetter() {
      var today = new Date();
      var h = today.getHours();
      if (h > 20 || h < 7) {
        $("html").css("background-color", "#212121")
        $("body").css("background-color", "#212121")

        $("#logotip").attr("src", "./static/images/icon-test-dark-alt.png");

        $("#dataTable").addClass("my-table-dark");
        $(".fakeThead").css("background-color", "#212121");
        
        $("thead th").css("background-color", "#212121")
        $("thead th").css("color", "white")

        $(".modal-content").addClass("elegant-color-dark");
        $(".modal-body").addClass("text-white");

        currentTheme = "dark"
        
      }
    }

    var country = "";
    $.getJSON('https://json.geoiplookup.io', function (data) {})
      .done(function (data) {
        country = data.country_name
        colorCountry(country);
      })

    var region = "";

    // Search
    $("#search").on("keyup", function () {
      var value = $(this).val().toLowerCase();
      $("#dataTable tbody tr").filter(function () {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
      });
      colorCountry();
    });

    var data = JSON.parse({{ data | tojson | safe }});
    var globalData = {{ globalData | tojson | safe }};
    var europeData = {{ europeData | tojson | safe }};
    var graphData = JSON.parse({{ graphData | tojson | safe }})
    var goodResponse = "{{ goodResponse }}";

    function tableBodyCreate(region) {
      var tbl = document.getElementById('dataTable');
      var tbdy = document.createElement('tbody');
      $("#dataTable tbody").empty();
      for (var i = 0; i < data.length; i++) {
        if (data[i]["region"] == region || region == "") {
          var row = tbdy.insertRow();
          var cell = row.insertCell();
          row.setAttribute("class", "countryExpand");
          row.setAttribute("id", i);
          cell.innerHTML = data[i]["slovenianName"]
          cell.setAttribute("id", data[i]["name"])
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.setAttribute("class", "d-none d-lg-table-cell text-right");
          cell.innerHTML = data[i]["countryPopulation"];
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.innerHTML = data[i]["infected"];
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.innerHTML = data[i]["infectedToday"];
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.setAttribute("class", "d-none d-sm-table-cell text-right");
          cell.innerHTML = data[i]["infectedRatio"] + "%";
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.innerHTML = data[i]["dead"];
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.setAttribute("class", "d-none d-sm-table-cell text-right");
          cell.innerHTML = data[i]["deadToday"];
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.setAttribute("class", "d-none d-md-table-cell text-right");
          cell.innerHTML = data[i]["deadRatio"] + "%";
          cell = row.insertCell();
          cell.setAttribute("align", "right");
          cell.setAttribute("class", "d-none d-md-table-cell text-right");
          cell.innerHTML = data[i]["cured"];
        }
      }
      tbl.appendChild(tbdy);
      colorCountry();
    }

    function tableCreate(region) {
      var headers = ["Država", "Populacija", "Okuženi", "Okuženi danes", "Obolevnost", "Umrli", "Umrli danes", "Umrljivost",
        "Ozdraveli"
      ];
      var headersIcons = ["fas fa-flag", "", "fas fa-biohazard", "fas fa-calendar-day", "", "fas fa-book-dead", "", "",
        "fas fa-smile"
      ];
      var tbl = document.getElementById('dataTable');
      var tbdy = document.createElement('tbody');
      var thdr = tbl.createTHead();
      thdr.setAttribute("id", "tableHead")
      var row = thdr.insertRow();
      for (var i = 0; i < headers.length; i++) {
        var cell = document.createElement("th");
        cell.innerHTML = '<div class="d-none d-sm-block">' + headers[i] + '</div><div class="d-sm-none"><i class="' +
          headersIcons[i] + '"></i></div>'
        if (headers[i] == "Okuženi") {
          cell.setAttribute("data-sort-default", "")
        }
        if (i != 0) {
          cell.setAttribute("class", "text-right col");
        } else {
          cell.setAttribute("class", "col");
          cell.innerHTML = '<div>' + headers[i] + '</div>';
        }
        if (headers[i] == "Ozdraveli" || headers[i] == "Umrljivost") {
          cell.setAttribute("class", "d-none d-md-table-cell text-right col");
        }
        if (headers[i] == "Obolevnost" || headers[i] == "Umrli danes") {
          cell.setAttribute("class", "d-none d-sm-table-cell text-right col");
        }
        if (headers[i] == "Populacija") {
          cell.setAttribute("class", "d-none d-lg-table-cell text-right col");
        }
        row.appendChild(cell);
      }
      tableBodyCreate(region);
    }

    if (goodResponse == "True") {
      tableCreate(region);
    } else {
      var mainDiv = document.getElementById("mainDiv");
      mainDiv.innerHTML =
        '<div class="text-center" style="margin-top: 50px !important;"><h1>Dostop do podatkov trenutno ni mogoč! 😟</h1><p class="lead">Uporabite alternativne spletne aplikacije za pregled podatkov.<br>👉 <a href="https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">COVID-19 Tracker by CSSE</a></p></div>';
      var footerDiv = document.getElementById("footerDiv")
    }
      // Zaženemo plugin za sortiranje
    new Tablesort(document.getElementById("dataTable"), {
      descending: true
    });
    themeSetter();
    colorCountry();

    function colorCountry(country) {
      var table = $("#dataTable");
      var tbody = table.find("tbody");
      var rows = tbody.find("tr");
      for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].getElementsByTagName("td")
        if (cells[0].getAttribute("id")==country) {
          rows[i].classList.add("myCountry");
          rows[i].style.backgroundColor = "#ffff72";
          rows[i].style.color = "black";
        }
      }
    };

    $(document).ready(function() {
      $(document).on("click", ".countryExpand" , function() {
        console.log("drek");
        var i = $(this).attr("id");
        $("#countryDetailsModalTitle").text(data[i]["slovenianName"]);
        $("#populationModal").text(data[i]["countryPopulation"]);
        $("#infectedModal").text(data[i]["infected"]);
        $("#infectedTodayModal").text(data[i]["infectedToday"]);
        $("#infectedRatioModal").text(data[i]["infectedRatio"] + "%");
        $("#deadModal").text(data[i]["dead"]);
        $("#deadTodayModal").text(data[i]["deadToday"]);
        $("#deadRatioModal").text(data[i]["deadRatio"] + "%");
        $("#curedModal").text(data[i]["cured"]);
        $("#activeModal").text(data[i]["active"]);
        $("#criticalModal").text(data[i]["critical"]);
        $("#countryFlag").attr("src", data[i]["flag"])
        $("#countryDensity").text(data[i]["density"] + " P/Km²")
        $("#countryDetailsModal").modal("show");
        showGraph(data[i]["A2code"]);
      })
    })

    
    $(".tableFixHead").on("scroll", function (event) {
      var y = $(this).scrollTop(); 
      if (y > 0) {  
        $(".fakeThead").addClass('shadows'); 
      }
      else { 
        $(".fakeThead").removeClass('shadows'); 
      }
    });
    
    $(document).ready(function() {
      $("#logotip").click(function() {
        switchTheme();
      })
    })


    function switchTheme() {
      if (currentTheme == "light") {
        //$("#logotip").css("color", "black");
        $("#logotip").attr("src", "./static/images/icon-test-dark-alt.png");
        $("html").css("background-color", "#212121")
        $("body").css("background-color", "#212121")

        $("#dataTable").addClass("my-table-dark");
        $(".fakeThead").css("background-color", "#212121");
        
        $("thead th").css("background-color", "#212121")
        $("thead th").css("color", "white")

        $(".modal-content").addClass("elegant-color");
        $(".modal-body").addClass("text-white");
        currentTheme = "dark"
      }
      else {
        // vklopimo light theme
        //$("#logotip").css("color", "white");
        $("#logotip").attr("src", "./static/images/icon-test-alt.png");
        $("html").css("background-color", "white")
        $("body").css("background-color", "white")

        $("#dataTable").removeClass("my-table-dark");
        $(".fakeThead").css("background-color", "white");
        
        $("thead th").css("background-color", "white")
        $("thead th").css("color", "black")

        $(".modal-content").removeClass("elegant-color");
        $(".modal-body").removeClass("text-white");
        currentTheme = "light"
      }
    }


    var ctxL = document.getElementById("lineChart").getContext('2d');
    var myLineChart = new Chart(ctxL, {
      type: 'line',
      data: {
        labels: graphData["dates"],
        datasets: [
          {
            label: "Okuženi",
            data: graphData["SI"]["confirmed"],
            backgroundColor: [
              'rgba(0, 137, 132, .2)',
            ],
            borderColor: [
              'rgba(0, 10, 130, .7)',
            ],
            borderWidth: 2
          },
          {
            label: "Umrli",
            data: graphData["SI"]["dead"],
            backgroundColor: [
              'rgba(105, 0, 132, .2)',
            ],
            borderColor: [
              'rgba(200, 99, 132, .7)',
            ],
            borderWidth: 2
          },
          /*
          {
            label: "Ozdraveli",
            data: graphData["SI"]["recovered"],
            backgroundColor: [
              'rgba(0, 250, 220, .2)',
            ],
            borderColor: [
              'rgba(0, 213, 132, .7)',
            ],
            borderWidth: 2
          }
          */
        ] 
      },
      options: {
        responsive: true,
        scales: {
          xAxes: [{
            gridLines: {
              display:false
            }
          }],
          yAxes: [{
            gridLines: {
              display:false
            }   
          }]
        },
        legend: {
          position: "bottom"
        }
      }
    });

    function showGraph(countryCode) {
      myLineChart.data.datasets[0].data = graphData[countryCode]["confirmed"]
      myLineChart.data.datasets[1].data = graphData[countryCode]["dead"]
      //myLineChart.data.datasets[2].data = graphData[countryCode]["recovered"]
      myLineChart.update();
    }

    function modeSwitch() {
      $("#globeSwitch")[0].classList.toggle("fa-globe-europe");
      if (region == "Europe") {
        region = ""
        $("#globeText").text("Svet\xa0\xa0");
        $("#globalDeaths").text(globalData["deaths"]);
        $("#globalRecovered").text(globalData["recovered"]);
        $("#globalCases").text(globalData["cases"]);
      }
      else {
        region = "Europe";
        $("#globeText").text("Evropa");
        $("#globalDeaths").text(europeData["deaths"]);
        $("#globalRecovered").text(europeData["recovered"]);
        $("#globalCases").text(europeData["cases"]);
      };
      tableBodyCreate(region)
    }

  </script>

</body>

</html>